{% extends "layout.html" %}
{% block content %}

<style>
    .dashboard-header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .order-card {
        border: none;
        border-radius: 12px;
        background: #fff;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
    }
    
    .order-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }

    .card-header-custom {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        padding: 1rem 1.5rem;
    }

    .status-border { border-left: 6px solid transparent; }
    .status-Shipped { border-left-color: #198754; }
    .status-Cancelled { border-left-color: #dc3545; }
    .status-On-Hold { border-left-color: #ffc107; }
    .status-In-Process { border-left-color: #0dcaf0; }
    .status-Resolved { border-left-color: #0d6efd; }
</style>

<div class="container mt-4 mb-5">

    <div class="mb-4">
        <a href="{{ url_for('employee_dashboard') }}" class="text-decoration-none text-muted small fw-bold">
            &larr; Back to Dashboard
        </a>
    </div>

    {% if customer %}
    <div class="card shadow-sm border-0 mb-5 bg-light">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-1 text-center text-primary display-4">
                    <i class="bi bi-person-circle"></i> ğŸ‘¤
                </div>
                <div class="col-md-7">
                    <h2 class="fw-bold mb-1">{{ customer.customerName }}</h2>
                    <p class="text-muted mb-2">
                        {{ customer.contactFirstName }} {{ customer.contactLastName }} 
                        <span class="mx-2">|</span> 
                        Example: {{ customer.country }}
                    </p>
                    <div class="small text-secondary">
                        <span class="me-3">ğŸ“ {{ customer.addressLine1 }}, {{ customer.city }}</span>
                        <span>ğŸ“ {{ customer.phone }}</span>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0 border-start ps-md-4">
                    <small class="text-uppercase text-muted fw-bold">Credit Limit</small>
                    <div class="display-6 text-success fw-bold">
                        ${{ "{:,.2f}".format(customer.creditLimit) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}


    <div class="dashboard-header d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h2 class="fw-bold mb-1">ğŸ“¦ Order History</h2>
            <p class="mb-0 opacity-75">Manage orders for {{ customer.customerName }}</p>
        </div>

        <form method="GET" action="{{ url_for('employee_view_customer_orders', customer_num=customer.customerNumber) }}" class="d-flex align-items-center mt-3 mt-md-0">
            <label for="sort" class="me-2 fw-bold text-white small">Sort by:</label>
            <select name="sort" id="sort" class="form-select form-select-sm border-0 shadow-none" 
                    style="width: 150px; background-color: rgba(255,255,255,0.2); color: white; cursor: pointer;" 
                    onchange="this.form.submit()">
                <option value="newest" class="text-dark" {% if sort_option == 'newest' %}selected{% endif %}>ğŸ“… Newest First</option>
                <option value="oldest" class="text-dark" {% if sort_option == 'oldest' %}selected{% endif %}>ğŸ“… Oldest First</option>
            </select>
        </form>
    </div>

    {% if orders %}
    <div class="row g-4 mb-5">
        {% for order in orders %}
        <div class="col-12">
            
            <a href="{{ url_for('order_detail', order_number=order.orderNumber) }}" class="text-decoration-none text-dark">
                <div class="card order-card shadow-sm status-{{ order.status | replace(' ', '-') }} status-border">
                    
                    <div class="card-header-custom d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="bg-white p-2 rounded-circle shadow-sm me-3 text-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-seam" viewBox="0 0 16 16">
                                  <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-1.187 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                                </svg>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold text-uppercase small text-muted">Order Number</h6>
                                <span class="fs-5 fw-bold font-monospace">#{{ order.orderNumber }}</span>
                            </div>
                        </div>
                        
                        <div class="text-end">
                            <small class="text-muted d-block">Order Date</small>
                            <span class="fw-semibold">
                                {{ order.orderDate.strftime('%d %b, %Y') }}
                            </span>
                        </div>
                    </div>

                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <span class="text-muted small">Status:</span>
                                <div class="mt-1">
                                    {% if order.status == 'Shipped' %}
                                        <span class="badge rounded-pill bg-success px-3 py-2">âœ… Shipped</span>
                                        {% if order.shippedDate %}
                                            <small class="text-success ms-2 fw-bold">on {{ order.shippedDate.strftime('%d %b') }}</small>
                                        {% endif %}
                                    {% elif order.status == 'Cancelled' %}
                                        <span class="badge rounded-pill bg-danger px-3 py-2">ğŸš« Cancelled</span>
                                    {% elif order.status == 'In Process' %}
                                        <span class="badge rounded-pill bg-info text-dark px-3 py-2">â³ In Process</span>
                                    {% elif order.status == 'On Hold' %}
                                        <span class="badge rounded-pill bg-warning text-dark px-3 py-2">âœ‹ On Hold</span>
                                    {% else %}
                                        <span class="badge rounded-pill bg-secondary px-3 py-2">{{ order.status }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-4 mb-3 mb-md-0">
                                {% if order.comments %}
                                    <div class="d-flex text-muted small fst-italic bg-light p-2 rounded">
                                        <div class="me-2">ğŸ’¬</div>
                                        <div class="text-truncate">{{ order.comments }}</div>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-2 text-md-end">
                                <span class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                    Details &rarr;
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card border-0 shadow-sm text-center py-5 mb-5">
        <div class="card-body">
            <div class="mb-3 text-secondary" style="font-size: 3rem; opacity: 0.2;">ğŸ“¦</div>
            <h4 class="text-muted">No order history</h4>
            <p class="text-secondary">This customer hasn't placed any orders yet.</p>
        </div>
    </div>
    {% endif %}


    <h3 class="fw-bold text-secondary mb-3 mt-5 border-bottom pb-2">
        ğŸ’³ Payment History
    </h3>

    {% if is_manager %}
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Date</th>
                            <th>Check #</th>
                            <th>Amount</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in payments %}
                        <tr>
                            <td class="ps-4">{{ p.paymentDate }}</td>
                            <td class="font-monospace text-muted">{{ p.checkNumber }}</td>
                            <td class="fw-bold text-success">${{ "{:,.2f}".format(p.amount) }}</td>
                            <td class="text-end pe-4">
                                <a href="{{ url_for('edit_payment', customer_num=customer.customerNumber, check_num=p.checkNumber) }}" 
                                   class="btn btn-sm btn-outline-warning me-1">
                                   Edit
                                </a>
                                <form action="{{ url_for('delete_payment') }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure? This deletes the financial record.');">
                                    <input type="hidden" name="customer_number" value="{{ customer.customerNumber }}">
                                    <input type="hidden" name="check_number" value="{{ p.checkNumber }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">No payments recorded.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% else %}
        <div class="alert alert-secondary d-flex align-items-center">
            <span class="fs-4 me-2">ğŸ”’</span>
            <div>
                <strong>Restricted Access:</strong> Payment details are visible only to Management (VP/Managers).
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}