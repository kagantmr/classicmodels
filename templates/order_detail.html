{% extends "layout.html" %}
{% block content %}
<h2>Order #{{ order.orderNumber }}</h2>
<p>
  <strong>Date:</strong> {{ order.orderDate }}  
  |  
  <strong>Status:</strong>
  <span class="badge 
      {% if order.status == 'In Process' %} bg-info 
      {% elif order.status == 'Shipped' %} bg-success
      {% elif order.status == 'Cancelled' %} bg-danger
      {% elif order.status == 'On Hold' %} bg-warning text-dark
      {% else %} bg-secondary
      {% endif %}">
      {{ order.status }}
  </span>
</p>

<hr>   <div class="card mb-4">
    <div class="card-header bg-light">
        <strong>Order Comments / Notes</strong>
    </div>
    <div class="card-body">
        {% if session.get('user_type') == 'employee' %}
            <form action="{{ url_for('update_comment_route', order_number=order.orderNumber) }}" method="POST">
                <div class="input-group">
                    <textarea name="new_comment" class="form-control" rows="2">{{ order.comments or '' }}</textarea>
                    <button class="btn btn-outline-primary" type="submit">Update Note</button>
                </div>
                <div class="form-text text-muted">Internal notes or updates regarding this order.</div>
            </form>
        {% else %}
            <p class="mb-0 text-muted fst-italic">
                {{ order.comments or 'No notes provided.' }}
            </p>
        {% endif %}
    </div>
</div>

<hr>

<h4>Items</h4>
<table class="table table-striped align-middle">
  <thead>
    <tr>
        <th>Product</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>Actions</th> 
    </tr>
  </thead>
  <tbody>
    {% for it in items %}
    <tr>
      <td>
        <a href="{{ url_for('product_page', product_code=it.productCode) }}">
          {{ it.productName }}
        </a>
      </td>
      
      <td>
        {% if order.status == 'In Process' %}
            <form action="{{ url_for('update_order_item', detail_id=it.orderDetailsNumber) }}" method="POST" class="d-flex align-items-center">
                <input type="number" name="quantity" value="{{ it.quantityOrdered }}" min="1" class="form-control form-control-sm me-2" style="width: 70px;">
                <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
            </form>
        {% else %}
            {{ it.quantityOrdered }}
        {% endif %}
      </td>

      <td>${{ "%.2f"|format(it.priceEach) }}</td>
      <td>${{ "%.2f"|format(it.quantityOrdered * it.priceEach) }}</td>

      <td>
        {% if order.status == 'In Process' %}
            <form action="{{ url_for('delete_order_item', detail_id=it.orderDetailsNumber) }}" method="POST" onsubmit="return confirm('Are you sure you want to remove this item?');">
                <button type="submit" class="btn btn-sm btn-danger">Remove</button>
            </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<hr>

{% if session.get('user_type') == 'customer' and order.status == "In Process" %}
<form action="{{ url_for('cancel_order', order_number=order.orderNumber) }}"
      method="POST"
      onsubmit="return confirm('Are you sure you want to cancel this order? This cannot be undone.');">
    <button class="btn btn-danger mt-3">Cancel Order</button>
</form>
{% endif %}

{% endblock %}