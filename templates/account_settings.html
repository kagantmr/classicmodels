{% extends "layout.html" %}
{% block content %}

<div class="container mt-4">

  <h2 class="mb-4">Account Settings</h2>

  <!-- Basic Info Card -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <strong>Your Profile</strong>
      {% if user_type == 'customer' %}
      <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#editProfileModal">
        ‚úèÔ∏è Edit Profile
      </button>
      {% endif %}
    </div>
    <div class="card-body">
      <p><strong>Name:</strong> {{ user.contactFirstName if user_type=='customer' else user.firstName }}
         {{ user.contactLastName if user_type=='customer' else user.lastName }}</p>

      {% if user_type == 'customer' %}
        <p><strong>Role:</strong> Customer</p>
        <p><strong>Customer Number:</strong> {{ user.customerNumber }}</p>
        <p><strong>Phone:</strong> {{ user.phone }}</p>
        <p><strong>Address:</strong> {{ user.addressLine1 }}, {{ user.city }}, {{ user.country }}</p>
      {% else %}
        <p><strong>Role:</strong> Employee</p>
        <p><strong>Employee Number:</strong> {{ user.employeeNumber }}</p>
        <p><strong>Job Title:</strong> {{ user.jobTitle }}</p>
        <p><strong>Office Code:</strong> {{ user.officeCode }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
      {% endif %}
    </div>
  </div>

  {% if user_type == 'customer' %}
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProfileModalLabel">Edit Profile Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form action="{{ url_for('update_customer_profile_route') }}" method="POST">
          <div class="modal-body">
            
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">First Name</label>
                    <input type="text" name="contactFirstName" class="form-control" value="{{ user.contactFirstName }}" required>
                </div>
                <div class="col">
                    <label class="form-label">Last Name</label>
                    <input type="text" name="contactLastName" class="form-control" value="{{ user.contactLastName }}" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Phone</label>
                <input type="text" name="phone" class="form-control" value="{{ user.phone }}" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Address Line 1</label>
                <input type="text" name="addressLine1" class="form-control" value="{{ user.addressLine1 }}" required>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">City</label>
                    <input type="text" name="city" class="form-control" value="{{ user.city }}" required>
                </div>
                <div class="col">
                    <label class="form-label">Country</label>
                    <input type="text" name="country" class="form-control" value="{{ user.country }}" required>
                </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  {% if user_type == "customer" %}
  <!-- Financial Summary for Customers -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <strong>Financial Summary</strong>
    </div>

    <div class="card-body">

      <p><strong>Total Orders:</strong>
        ${{ "{:,.2f}".format(user.total_orders) if user.total_orders else "0.00" }}
      </p>

      <p><strong>Total Payments:</strong>
        ${{ "{:,.2f}".format(user.total_payments) if user.total_payments else "0.00" }}
      </p>

      {% set balance = (user.total_orders or 0) - (user.total_payments or 0) %}
      <p><strong>Outstanding Balance:</strong>
        {% if balance > 0 %}
          <span class="badge bg-danger">${{ "{:,.2f}".format(balance) }} owed</span>
        {% else %}
          <span class="badge bg-success">No debt üéâ</span>
        {% endif %}
      </p>

    </div>
  </div>
  {% endif %}


  <!-- Security Card -->
  <div class="card">
    <div class="card-header bg-secondary text-white">
      <strong>Security</strong>
    </div>
    <div class="card-body">
      <a href="{{ url_for('change_password') }}" class="btn btn-outline-dark">
        Change Password
      </a>
    </div>
  </div>

</div>

{% if user_type == 'customer' %}
  <hr class="my-5">
  
  <div class="card border-danger mb-5">
    <div class="card-header bg-danger text-white">
      <strong>Danger Zone</strong>
    </div>
    <div class="card-body">
      <h5 class="card-title">Delete Account</h5>
      <p class="card-text text-muted">
        Permanently remove your Personal Data, Order History, and Account Information from our servers. 
        <br><strong>Warning:</strong> This action is not reversible.
      </p>
      
      <button onclick="handleDeleteRequest({{ balance if balance else 0 }})" class="btn btn-outline-danger">
        Delete My Account
      </button>
    </div>
  </div>

  <script>
    function handleDeleteRequest(currentBalance) {
      // 1. Debt Check (Client-Side Check)
      if (currentBalance > 0) {
        alert("Action Denied:\n\nYou currently have an outstanding balance of $" + currentBalance.toFixed(2) + ".\n\nYou must settle your debt before deleting your account.");
        return; // Stop operation
      }

      // 2. First warning (Pop-up)
      if (confirm("Are you really sure you want to delete your account?\n\nThis action will permanently erase all your data and cannot be undone.")) {
        // 3. Redirect to delete_account_page to check password
        window.location.href = "{{ url_for('delete_account') }}"; 
      }
    }
  </script>
{% endif %}

{% endblock %}