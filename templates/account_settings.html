{% extends "layout.html" %}
{% block content %}

<style>
    .settings-container {
        max-width: 850px;
        margin: 0 auto;
        padding-bottom: 4rem;
    }

    .card-settings {
        background-color: #252a37;
        border: 1px solid #34495e;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .card-header-settings {
        background-color: #2c3140;
        border-bottom: 1px solid #34495e;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* YENÄ° PRIMARY COLOR ENTEGRASYONU (#0e3a6d) */
    .header-primary {
        background: linear-gradient(135deg, #0e3a6d, #164f91);
        color: white;
    }

    .header-danger {
        background: linear-gradient(135deg, #741b1b, #a52828);
        color: white;
    }

    .text-label {
        color: #adb5bd;
        font-size: 0.9rem;
        margin-bottom: 0.2rem;
    }

    .text-value {
        color: #fff;
        font-weight: 500;
        font-size: 1.05rem;
        margin-bottom: 1rem;
    }

    .font-mono {
        font-family: 'SF Mono', 'Menlo', Monaco, Consolas, monospace;
    }

    /* MODAL KOYU TEMA AYARLARI */
    .modal-content-dark {
        background-color: #252a37;
        border: 1px solid #34495e;
        color: #e0e0e0;
    }

    .modal-header-dark {
        border-bottom: 1px solid #34495e;
        background-color: #2c3140;
    }

    .modal-footer-dark {
        border-top: 1px solid #34495e;
    }

    .form-control-dark {
        background-color: #1a1e2b;
        border: 1px solid #34495e;
        color: #fff;
        border-radius: 8px;
    }

    .form-control-dark:focus {
        background-color: #1a1e2b;
        border-color: #0e3a6d;
        color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(14, 58, 109, 0.25);
    }

    .btn-edit {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.2s;
    }

    .btn-edit:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: #fff;
    }

    .text-readable-secondary {
        color: #adb5bd !important;
    }
</style>

<div class="container mt-5 settings-container">

    <div class="d-flex align-items-center mb-4">
        <h2 class="text-white fw-bold mb-0" style="font-family: 'Playfair Display', serif;">Account Settings</h2>
    </div>

    <div class="card card-settings">
        <div class="card-header-settings">
            <strong class="text-white fs-5">Profile Information</strong>
            {% if user_type == 'customer' %}
            <button type="button" class="btn btn-sm btn-edit" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <i class="bi bi-pencil-square me-1"></i> Edit Profile
            </button>
            {% endif %}
        </div>
        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="text-label">Full Name</div>
                        <div class="text-value">
                            {{ user.contactFirstName if user_type=='customer' else user.firstName }}
                            {{ user.contactLastName if user_type=='customer' else user.lastName }}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="text-label">Account Role</div>
                        <div class="text-value text-capitalize">{{ user_type }}</div>
                    </div>
                </div>
            </div>

            <hr style="border-color: #34495e;">

            {% if user_type == 'customer' %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="text-label">Customer Number</div>
                        <div class="text-value font-mono">#{{ user.customerNumber }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="text-label">Phone Number</div>
                        <div class="text-value">{{ user.phone }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="text-label">Billing Address</div>
                        <div class="text-value">
                            {{ user.addressLine1 }}<br>
                            {{ user.city }}, {{ user.country }}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="text-label">Employee ID</div>
                        <div class="text-value font-mono">#{{ user.employeeNumber }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="text-label">Email</div>
                        <div class="d-flex align-items-center">
                            <div class="text-value me-3 mb-0">{{ user.email }}</div>
                            <button class="btn btn-sm btn-edit" data-bs-toggle="modal" data-bs-target="#editEmailModal">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="text-label">Job Title</div>
                        <div class="text-value">{{ user.jobTitle }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="text-label">Office Code</div>
                        <div class="text-value">{{ user.officeCode }}</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

</div>

{% if user_type == 'employee' %}
<div class="modal fade" id="editEmailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark">
            <div class="modal-header modal-header-dark">
                <h5 class="modal-title">Update Email Address</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form action="{{ url_for('update_employee_email') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="text-label">New Email Address</label>
                        <input type="email" name="email" class="form-control form-control-dark" value="{{ user.email }}"
                            required>
                    </div>
                </div>
                <div class="modal-footer modal-footer-dark">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"
                        style="background-color: #0e3a6d; border-color: #0e3a6d;">Update Email</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% if user_type == 'customer' %}
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark">
            <div class="modal-header modal-header-dark">
                <h5 class="modal-title">Edit Profile Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form action="{{ url_for('update_customer_profile_route') }}" method="POST">
                <div class="modal-body">

                    <div class="row mb-3">
                        <div class="col">
                            <label class="text-label">First Name</label>
                            <input type="text" name="contactFirstName" class="form-control form-control-dark"
                                value="{{ user.contactFirstName }}" required>
                        </div>
                        <div class="col">
                            <label class="text-label">Last Name</label>
                            <input type="text" name="contactLastName" class="form-control form-control-dark"
                                value="{{ user.contactLastName }}" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="text-label">Phone</label>
                        <input type="text" name="phone" class="form-control form-control-dark" value="{{ user.phone }}"
                            required>
                    </div>

                    <div class="mb-3">
                        <label class="text-label">Address Line 1</label>
                        <input type="text" name="addressLine1" class="form-control form-control-dark"
                            value="{{ user.addressLine1 }}" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            <label class="text-label">City</label>
                            <input type="text" name="city" class="form-control form-control-dark"
                                value="{{ user.city }}" required>
                        </div>
                        <div class="col">
                            <label class="text-label">Country</label>
                            <input type="text" name="country" class="form-control form-control-dark"
                                value="{{ user.country }}" required>
                        </div>
                    </div>

                </div>
                <div class="modal-footer modal-footer-dark">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"
                        style="background-color: #0e3a6d; border-color: #0e3a6d;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card card-settings">
    <div class="card-header-settings header-primary">
        <strong class="fs-5"><i class="bi bi-wallet2 me-2"></i> Financial Summary</strong>
    </div>

    <div class="card-body p-4">
        <div class="row text-center">
            <div class="col-md-4 border-end border-secondary">
                <div class="text-label">Total Orders</div>
                <div class="text-white fs-4 fw-bold font-mono">
                    ${{ "{:,.2f}".format(user.total_orders) if user.total_orders else "0.00" }}
                </div>
            </div>
            <div class="col-md-4 border-end border-secondary">
                <div class="text-label">Total Payments</div>
                <div class="text-white fs-4 fw-bold font-mono">
                    ${{ "{:,.2f}".format(user.total_payments) if user.total_payments else "0.00" }}
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-label">Outstanding Balance</div>
                {% set balance = (user.total_orders or 0) - (user.total_payments or 0) %}
                <div class="fs-4 fw-bold font-mono">
                    {% if balance > 0 %}
                    <span class="text-danger">${{ "{:,.2f}".format(balance) }}</span>
                    <div style="font-size: 0.8rem;" class="text-danger opacity-75">Payment Required</div>
                    {% else %}
                    <span class="text-success">No debt</span>
                    <div style="font-size: 0.8rem;" class="text-success opacity-75">All clear</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}


<div class="card card-settings">
    <div class="card-header-settings">
        <strong class="text-white fs-5"><i class="bi bi-shield-lock me-2"></i> Security</strong>
    </div>
    <div class="card-body p-4 d-flex justify-content-between align-items-center">
        <div>
            <h6 class="text-white mb-1">Password</h6>
            <p class="text-readable-secondary small mb-0">Update your password regularly to keep your account secure.
            </p>
        </div>
        <a href="{{ url_for('change_password') }}" class="btn btn-outline-light"
            style="background-color: #0e3a6d; border-color: #34495e;">
            Change Password
        </a>
    </div>
</div>

{% if user_type == 'customer' %}
<div class="card card-settings" style="border-color: #34495e;">
    <div class="card-header-settings header-danger">
        <strong class="fs-5"><i class="bi bi-exclamation-triangle me-2"></i>DELETE ACCOUNT</strong>
    </div>
    <div class="card-body p-4">
        <p class="text-readable-secondary mb-4" style="max-width: 600px;">
            Permanently remove your Personal Data, Order History, and Account Information from our servers.
            This action is <strong>not reversible</strong>.
        </p>

        <button onclick="handleDeleteRequest({{ balance if balance else 0 }})" class="btn btn-outline-danger"
            style="background-color: #741b1b; color: white; border-color: #34495e;">
            Delete My Account
        </button>
    </div>
</div>

<script>
    function handleDeleteRequest(currentBalance) {
        if (currentBalance > 0) {
            alert("Action Denied:\n\nYou currently have an outstanding balance of $" + currentBalance.toFixed(2) + ".\n\nYou must settle your debt before deleting your account.");
            return;
        }
        if (confirm("Are you really sure you want to delete your account?\n\nThis action will permanently erase all your data and cannot be undone.")) {
            window.location.href = "{{ url_for('delete_account') }}";
        }
    }
</script>
{% endif %}

</div>

{% endblock %}