{% extends "layout.html" %}

{% block content %}

<h1 class="mb-4">Product Management</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
  <p class="mb-0 text-muted">
    Manage products in the ClassicModels catalog.
  </p>

  <!-- Correct NEW PRODUCT button -->
  <a href="{{ url_for('create_product') }}" class="btn btn-primary">
    + Add New Product
  </a>
</div>

<!-- Per-page + Filters + Sort -->
<form method="get" class="mb-3 d-flex gap-2 flex-wrap align-items-center">
  <label class="me-1">Show:</label>
  <select name="per_page" class="form-select w-auto" onchange="this.form.submit()">
    <option value="5"  {% if per_page == 5 %}selected{% endif %}>5</option>
    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
  </select>

  <!-- Vendor filter -->
  <select name="vendor" class="form-select w-auto" onchange="this.form.submit()">
    <option value="">All vendors</option>
    {% for v in vendors %}
      <option value="{{ v }}" {% if vendor == v %}selected{% endif %}>{{ v }}</option>
    {% endfor %}
  </select>

  <!-- Product line filter -->
  <select name="line" class="form-select w-auto" onchange="this.form.submit()">
    <option value="">All lines</option>
    {% for l in lines %}
      <option value="{{ l }}" {% if line == l %}selected{% endif %}>{{ l }}</option>
    {% endfor %}
  </select>

  <!-- Sort -->
  <select name="sort" class="form-select w-auto" onchange="this.form.submit()">
    <option value="" disabled {% if not sort %}selected{% endif %}>Sort by</option>
    <option value="buyPrice_asc"  {% if sort == 'buyPrice_asc' %}selected{% endif %}>Buy Price ↑</option>
    <option value="buyPrice_desc" {% if sort == 'buyPrice_desc' %}selected{% endif %}>Buy Price ↓</option>
    <option value="stock_asc"     {% if sort == 'stock_asc' %}selected{% endif %}>In Stock ↑</option>
    <option value="stock_desc"    {% if sort == 'stock_desc' %}selected{% endif %}>In Stock ↓</option>
  </select>

  <!-- Reset to first page on any change -->
  <input type="hidden" name="page" value="1">
</form>

<table class="table table-striped table-hover table-sm">
  <thead>
    <tr>
      <th>Code</th>
      <th>Name</th>
      <th>Line</th>
      <th>Scale</th>
      <th>Vendor</th>
      <th class="text-end">In Stock</th>
      <th class="text-end">Buy Price</th>
      <th class="text-end">MSRP</th>
      <th class="text-end">Actions</th>
    </tr>
  </thead>

  <tbody>
    {% for p in products %}
    <tr>
      <td>{{ p.productCode }}</td>
      <td>{{ p.productName }}</td>
      <td>{{ p.productLine }}</td>
      <td>{{ p.productScale }}</td>
      <td>{{ p.productVendor }}</td>
      <td class="text-end">{{ p.quantityInStock }}</td>
      <td class="text-end">{{ "%.2f"|format(p.buyPrice) }}</td>
      <td class="text-end">{{ "%.2f"|format(p.MSRP) }}</td>

      <td class="text-end">
        <!-- Correct EDIT link -->
        <a href="{{ url_for('edit_product', product_code=p.productCode) }}"
           class="btn btn-sm btn-outline-secondary">
          Edit
        </a>

        <!-- Correct DELETE link -->
        <a href="{{ url_for('delete_product_route', product_code=p.productCode) }}"
           class="btn btn-sm btn-outline-danger">
          Delete
        </a>
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="9" class="text-center text-muted">No products found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center mt-4">

    <!-- Previous -->
    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
      <a class="page-link"
         href="?page={{ page-1 }}&per_page={{ per_page }}">Previous</a>
    </li>

    <!-- Page numbers -->
    {% for p in range(1, total_pages + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link"
           href="?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
      </li>
    {% endfor %}

    <!-- Next -->
    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
      <a class="page-link"
         href="?page={{ page+1 }}&per_page={{ per_page }}">Next</a>
    </li>

  </ul>
</nav>

{% endblock %}